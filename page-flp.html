<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>3D Flipbook with Bidirectional Drag</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Georgia", serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                perspective: 1200px;
                overflow: hidden;
            }

            .flipbook-container {
                position: relative;
                width: 700px;
                height: 500px;
                transform-style: preserve-3d;
            }

            .page {
                position: absolute;
                width: 350px;
                height: 500px;
                background: white;
                border: 2px solid #333;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                transform-style: preserve-3d;
                transform-origin: left center;
                transition: transform 0.6s ease-in-out;
                cursor: grab;
                border-radius: 5px;
                user-select: none;
            }

            .page:active {
                cursor: grabbing;
            }

            .page-front,
            .page-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                border-radius: 3px;
                overflow: hidden;
            }

            .page-back {
                transform: rotateY(180deg);
            }

            .page.flipped {
                transform: rotateY(-180deg);
            }

            .page.dragging {
                transition: none;
            }

            .page:nth-child(1) {
                z-index: 6;
                left: 0;
            }
            .page:nth-child(2) {
                z-index: 5;
                left: 0;
            }
            .page:nth-child(3) {
                z-index: 4;
                left: 0;
            }
            .page:nth-child(4) {
                z-index: 3;
                left: 0;
            }
            .page:nth-child(5) {
                z-index: 2;
                left: 0;
            }
            .page:nth-child(6) {
                z-index: 1;
                left: 0;
            }

            .page-content {
                position: relative;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                background: white;
            }

            .page-image {
                width: 100%;
                height: 80%;
                object-fit: cover;
                border-radius: 3px 3px 0 0;
            }

            .page-caption {
                padding: 15px;
                height: 20%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                background: white;
                border-radius: 0 0 3px 3px;
            }

            .page-title {
                font-size: 1.3em;
                font-weight: bold;
                color: #333;
                margin-bottom: 5px;
            }

            .page-text {
                font-size: 0.9em;
                color: #666;
                line-height: 1.4;
            }

            .page-number {
                position: absolute;
                bottom: 10px;
                right: 15px;
                font-size: 0.8em;
                color: #999;
                background: rgba(255, 255, 255, 0.8);
                padding: 2px 6px;
                border-radius: 10px;
            }

            .cover-page {
                background: linear-gradient(135deg, #ff6b6b, #feca57);
                color: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 40px;
            }

            .cover-page .page-title {
                color: white;
                font-size: 2.5em;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                margin-bottom: 20px;
            }

            .cover-page .page-text {
                color: rgba(255, 255, 255, 0.9);
                font-size: 1.2em;
            }

            .controls {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 10px;
                z-index: 1000;
            }

            .btn {
                padding: 12px 24px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1em;
                transition: all 0.3s;
                backdrop-filter: blur(10px);
            }

            .btn:hover {
                background: rgba(0, 0, 0, 0.9);
                transform: translateY(-2px);
            }

            .btn:disabled {
                background: rgba(0, 0, 0, 0.3);
                cursor: not-allowed;
                transform: none;
            }

            .drag-indicator {
                position: absolute;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
                width: 30px;
                height: 60px;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5em;
                color: rgba(0, 0, 0, 0.3);
                pointer-events: none;
                opacity: 1;
            }

            .instructions {
                position: fixed;
                top: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 0.9em;
                z-index: 1000;
                backdrop-filter: blur(10px);
            }

            /* Placeholder for when no images are loaded */
            .placeholder-image {
                width: 100%;
                height: 80%;
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 4em;
                color: white;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            /* Flipped page positioning - keep same layout */
            .page.flipped {
                transform: rotateY(-180deg);
            }
        </style>
    </head>
    <body>
        <div class="instructions">
            Drag left/right or click pages to flip ‚Ä¢ Use controls below
        </div>

        <div class="flipbook-container">
            <!-- Cover Page -->
            <div class="page" data-page="0">
                <div class="page-front cover-page">
                    <div class="page-title">My Photo Album</div>
                    <div class="page-text">
                        Drag left or right to explore beautiful memories
                    </div>
                    <div class="page-number">1</div>
                </div>
                <div class="page-back">
                    <div class="page-content">
                        <div class="placeholder-image">üì∑</div>
                        <div class="page-caption">
                            <div class="page-title">Welcome</div>
                            <div class="page-text">
                                Start your journey through this interactive
                                photo album.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">2</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
            </div>

            <!-- Page 1 -->
            <div class="page" data-page="1">
                <div class="page-front">
                    <div class="page-content">
                        <div class="placeholder-image">üåÖ</div>
                        <div class="page-caption">
                            <div class="page-title">Beautiful Sunrise</div>
                            <div class="page-text">
                                Drag your own images here to replace these
                                placeholders.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">3</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
                <div class="page-back">
                    <div class="page-content">
                        <div class="placeholder-image">üèîÔ∏è</div>
                        <div class="page-caption">
                            <div class="page-title">Mountain View</div>
                            <div class="page-text">
                                Replace with your favorite landscape photos.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">4</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
            </div>

            <!-- Page 2 -->
            <div class="page" data-page="2">
                <div class="page-front">
                    <div class="page-content">
                        <div class="placeholder-image">üå∏</div>
                        <div class="page-caption">
                            <div class="page-title">Spring Blossoms</div>
                            <div class="page-text">
                                Add your own nature photography here.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">5</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
                <div class="page-back">
                    <div class="page-content">
                        <div class="placeholder-image">üåä</div>
                        <div class="page-caption">
                            <div class="page-title">Ocean Waves</div>
                            <div class="page-text">
                                Perfect spot for your beach vacation photos.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">6</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
            </div>

            <!-- Page 3 -->
            <div class="page" data-page="3">
                <div class="page-front">
                    <div class="page-content">
                        <div class="placeholder-image">üåô</div>
                        <div class="page-caption">
                            <div class="page-title">Moonlit Night</div>
                            <div class="page-text">
                                Upload your night photography here.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">7</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
                <div class="page-back">
                    <div class="page-content">
                        <div class="placeholder-image">‚≠ê</div>
                        <div class="page-caption">
                            <div class="page-title">Starry Sky</div>
                            <div class="page-text">
                                Replace with your astronomical captures.
                            </div>
                        </div>
                    </div>
                    <div class="page-number">8</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
            </div>

            <!-- Back Cover -->
            <div class="page" data-page="4">
                <div class="page-front">
                    <div class="page-content">
                        <div class="placeholder-image">üìñ</div>
                        <div class="page-caption">
                            <div class="page-title">The End</div>
                            <div class="page-text">
                                Thanks for viewing this interactive flipbook!
                            </div>
                        </div>
                    </div>
                    <div class="page-number">9</div>
                    <div class="drag-indicator">‚ãÆ</div>
                </div>
                <div
                    class="page-back cover-page"
                    style="
                        background: linear-gradient(135deg, #2d3436, #636e72);
                    "
                >
                    <div class="page-title">Back Cover</div>
                    <div class="page-text">
                        Customize this flipbook with your own images and
                        content!
                    </div>
                    <div class="page-number">10</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="prevBtn">Previous</button>
            <button class="btn" id="nextBtn">Next</button>
            <button class="btn" id="resetBtn">Reset</button>
        </div>

        <script>
            class DraggableFlipbook {
                constructor() {
                    this.pages = document.querySelectorAll(".page");
                    this.totalPages = this.pages.length;
                    this.isDragging = false;
                    this.dragStartX = 0;
                    this.dragThreshold = 50;

                    this.prevBtn = document.getElementById("prevBtn");
                    this.nextBtn = document.getElementById("nextBtn");
                    this.resetBtn = document.getElementById("resetBtn");

                    this.currentPage = this.getCurrentPage();
                    this.init();
                }

                init() {
                    this.setupEventListeners();
                    this.updateControls();
                    this.updateZIndices();
                }

                getCurrentPage() {
                    // Number of flipped pages
                    let flipped = 0;
                    this.pages.forEach((page) => {
                        if (page.classList.contains("flipped")) flipped++;
                    });
                    return flipped;
                }

                setupEventListeners() {
                    // Page interactions
                    this.pages.forEach((page, index) => {
                        // Click to flip
                        page.addEventListener("click", (e) => {
                            if (!this.isDragging && !this.justFinishedDrag) {
                                this.flipPage(index);
                            }
                        });

                        // Touch and mouse drag events
                        page.addEventListener("mousedown", (e) =>
                            this.startDrag(e, index)
                        );
                        page.addEventListener(
                            "touchstart",
                            (e) => this.startDrag(e.touches[0], index),
                            { passive: true }
                        );
                    });

                    // Global drag events
                    document.addEventListener("mousemove", (e) => this.drag(e));
                    document.addEventListener(
                        "touchmove",
                        (e) => this.drag(e.touches[0]),
                        { passive: true }
                    );
                    document.addEventListener("mouseup", () => this.endDrag());
                    document.addEventListener("touchend", () => this.endDrag());

                    // Control buttons
                    this.prevBtn.addEventListener("click", () =>
                        this.previousPage()
                    );
                    this.nextBtn.addEventListener("click", () =>
                        this.nextPage()
                    );
                    this.resetBtn.addEventListener("click", () => this.reset());

                    // Prevent context menu on long press
                    document.addEventListener("contextmenu", (e) => {
                        if (e.target.closest(".page")) {
                            e.preventDefault();
                        }
                    });
                }

                startDrag(event, pageIndex) {
                    if (pageIndex >= this.totalPages) return;

                    const page = this.pages[pageIndex];
                    this.isDragging = false;
                    this.justFinishedDrag = false;
                    this.dragStartX = event.clientX || event.pageX;
                    this.currentDragPage = pageIndex;
                    this.dragPage = page;
                    this.dragDirection = null; // Will be set based on drag direction

                    // Add visual feedback
                    page.style.cursor = "grabbing";
                }

                drag(event) {
                    if (this.currentDragPage === undefined) return;

                    const currentX = event.clientX || event.pageX;
                    const deltaX = currentX - this.dragStartX;

                    // Only start dragging if moved enough
                    if (Math.abs(deltaX) > 10 && !this.isDragging) {
                        this.isDragging = true;
                        this.dragPage.classList.add("dragging");
                        
                        // Determine drag direction
                        this.dragDirection = deltaX > 0 ? 'right' : 'left';
                        
                        // Update z-indices to bring dragging page to front
                        this.updateZIndices();
                    }

                    if (this.isDragging) {
                        const page = this.dragPage;
                        const isFlipped = page.classList.contains("flipped");

                        if (this.dragDirection === 'left' && !isFlipped) {
                            // Dragging left to flip forward (next page)
                            const angle = Math.max(-180, (deltaX / 200) * 180);
                            page.style.transform = `rotateY(${angle}deg)`;
                        } else if (this.dragDirection === 'right' && isFlipped) {
                            // Dragging right to flip backward (previous page)
                            // For flipped pages, we need to reverse the transform
                            const angle = Math.min(0, -180 + ((deltaX / 200) * 180));
                            page.style.transform = `rotateY(${angle}deg)`;
                        } else if (this.dragDirection === 'right' && !isFlipped) {
                            // User is trying to drag right on an unflipped page
                            // Find the last flipped page to drag back instead
                            const lastFlippedPage = this.getLastFlippedPage();
                            if (lastFlippedPage && this.dragPage === this.pages[this.currentDragPage]) {
                                // Only switch once, and only if we haven't already switched
                                page.classList.remove("dragging");
                                this.dragPage = lastFlippedPage;
                                this.currentDragPage = parseInt(lastFlippedPage.dataset.page);
                                lastFlippedPage.classList.add("dragging");
                                // Update z-indices for new drag page
                                this.updateZIndices();
                                const angle = Math.min(0, -180 + ((deltaX / 200) * 180));
                                lastFlippedPage.style.transform = `rotateY(${angle}deg)`;
                            } else if (lastFlippedPage && this.dragPage === lastFlippedPage) {
                                // Continue dragging the switched page
                                const angle = Math.min(0, -180 + ((deltaX / 200) * 180));
                                lastFlippedPage.style.transform = `rotateY(${angle}deg)`;
                            }
                        }
                    }
                }

                getLastFlippedPage() {
                    // Find the last (rightmost) flipped page
                    let lastFlippedPage = null;
                    for (let i = this.totalPages - 1; i >= 0; i--) {
                        if (this.pages[i].classList.contains("flipped")) {
                            lastFlippedPage = this.pages[i];
                            break;
                        }
                    }
                    return lastFlippedPage;
                }

                endDrag() {
                    if (this.currentDragPage === undefined) return;

                    const page = this.dragPage;
                    page.style.cursor = "grab";

                    if (this.isDragging) {
                        this.justFinishedDrag = true;
                        // Reset this flag after a short delay
                        setTimeout(() => {
                            this.justFinishedDrag = false;
                        }, 100);

                        const currentTransform = page.style.transform;
                        const angle = this.extractAngle(currentTransform);
                        const isFlipped = page.classList.contains("flipped");

                        if (this.dragDirection === 'left' && !isFlipped) {
                            // Forward drag - flip if dragged enough
                            if (angle < -this.dragThreshold) {
                                this.flipPageForward(this.currentDragPage);
                            } else {
                                // Snap back to original position (front side)
                                page.classList.remove("dragging");
                                page.style.transform = "rotateY(0deg)";
                                // Remove transform after animation
                                setTimeout(() => {
                                    if (!page.classList.contains("flipped")) {
                                        page.style.transform = "";
                                    }
                                }, 600);
                            }
                        } else if (this.dragDirection === 'right' && isFlipped) {
                            // Backward drag - unflip if dragged enough
                            if (angle > -180 + this.dragThreshold) {
                                this.flipPageBackward(this.currentDragPage);
                            } else {
                                // Snap back to flipped state (back side)
                                page.classList.remove("dragging");
                                page.style.transform = "rotateY(-180deg)";
                                // Remove transform after animation  
                                setTimeout(() => {
                                    if (page.classList.contains("flipped")) {
                                        page.style.transform = "";
                                    }
                                }, 600);
                            }
                        } else {
                            // Invalid drag direction - snap back
                            page.classList.remove("dragging");
                            if (isFlipped) {
                                page.style.transform = "rotateY(-180deg)";
                                setTimeout(() => {
                                    if (page.classList.contains("flipped")) {
                                        page.style.transform = "";
                                    }
                                }, 600);
                            } else {
                                page.style.transform = "rotateY(0deg)";
                                setTimeout(() => {
                                    if (!page.classList.contains("flipped")) {
                                        page.style.transform = "";
                                    }
                                }, 600);
                            }
                        }
                    }

                    // Reset drag state
                    this.isDragging = false;
                    this.currentDragPage = undefined;
                    this.dragPage = null;
                    this.dragStartX = 0;
                    this.dragDirection = null;
                    
                    // Reset z-indices after drag ends
                    this.updateZIndices();
                }

                extractAngle(transform) {
                    const match = transform.match(/rotateY\(([^)]+)deg\)/);
                    return match ? parseFloat(match[1]) : 0;
                }

                flipPage(pageIndex) {
                    if (pageIndex >= this.totalPages) return;

                    const page = this.pages[pageIndex];
                    
                    if (!page.classList.contains("flipped")) {
                        // Forward flip - flip this page
                        this.flipPageForward(pageIndex);
                    } else {
                        // Backward flip - flip this flipped page back
                        this.flipPageBackward(pageIndex);
                    }
                }

                flipPageForward(pageIndex) {
                    const page = this.pages[pageIndex];
                    page.classList.remove("dragging");
                    page.style.transform = "";
                    page.classList.add("flipped");
                    this.playFlipSound();
                    this.updateState();
                }

                flipPageBackward(pageIndex) {
                    const page = this.pages[pageIndex];
                    page.classList.remove("flipped", "dragging");
                    page.style.transform = "";
                    this.playFlipSound();
                    this.updateState();
                }

                playFlipSound() {
                    const audio = document.getElementById("pageFlipSound");
                    if (audio) {
                        try {
                            audio.currentTime = 0;
                            audio.play();
                        } catch (error) {
                            console.error("Audio play error:", error);
                        }
                    }
                }

                nextPage() {
                    // Find the first unflipped page
                    for (let i = 0; i < this.totalPages; i++) {
                        if (!this.pages[i].classList.contains("flipped")) {
                            this.flipPageForward(i);
                            break;
                        }
                    }
                }

                previousPage() {
                    // Find the last flipped page
                    for (let i = this.totalPages - 1; i >= 0; i--) {
                        if (this.pages[i].classList.contains("flipped")) {
                            this.flipPageBackward(i);
                            break;
                        }
                    }
                }

                updateState() {
                    this.currentPage = this.getCurrentPage();
                    this.updateZIndices();
                    this.updateControls();
                }

                updateZIndices() {
                    // Currently dragging page should be on top
                    if (this.isDragging && this.dragPage) {
                        this.dragPage.style.zIndex = this.totalPages + 10;
                    }
                    
                    // Flipped pages should be below unflipped pages
                    let z = this.totalPages;
                    for (let i = 0; i < this.totalPages; i++) {
                        if (this.pages[i] === this.dragPage && this.isDragging) {
                            continue; // Skip the dragging page, it's already set above
                        }
                        if (this.pages[i].classList.contains("flipped")) {
                            this.pages[i].style.zIndex = i + 1; // Lower z-index for flipped
                        } else {
                            this.pages[i].style.zIndex = z;
                            z--;
                        }
                    }
                }

                reset() {
                    let anyFlipped = false;
                    this.pages.forEach((page) => {
                        if (page.classList.contains("flipped") || page.classList.contains("dragging")) {
                            anyFlipped = true;
                        }
                        page.classList.remove("flipped", "dragging");
                        page.style.transform = "";
                    });
                    
                    this.updateState();

                    // Play book close sound on reset
                    if (anyFlipped) {
                        const closeAudio = document.getElementById("bookCloseSound");
                        if (closeAudio) {
                            try {
                                closeAudio.currentTime = 0;
                                closeAudio.play();
                            } catch (error) {
                                console.error("Audio play error:", error);
                            }
                        }
                    }
                }

                updateControls() {
                    this.prevBtn.disabled = this.currentPage === 0;
                    this.resetBtn.disabled = this.currentPage === 0;
                    this.nextBtn.disabled = this.currentPage === this.totalPages;
                }
            }

            // Initialize the flipbook when the page loads
            document.addEventListener("DOMContentLoaded", () => {
                new DraggableFlipbook();
            });
        </script>
        <audio
            id="pageFlipSound"
            src="assets/turnpage.mp3"
            preload="auto"
        ></audio>
        <audio
            id="bookCloseSound"
            src="assets/book-close.mp3"
            preload="auto"
        ></audio>
    </body>
</html>